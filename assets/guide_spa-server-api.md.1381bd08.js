import{_ as a,c as s,o as n,a as e}from"./app.efe36196.js";const k='{"title":"HTTP API","description":"","frontmatter":{},"headers":[{"level":2,"title":"Authorization","slug":"authorization"},{"level":2,"title":"Simple API Without spa-client","slug":"simple-api-without-spa-client"},{"level":3,"title":"Get all domains status","slug":"get-all-domains-status"},{"level":3,"title":"Get specific domain status","slug":"get-specific-domain-status"},{"level":3,"title":"Get the domain upload file position info","slug":"get-the-domain-upload-file-position-info"},{"level":3,"title":"Update the domain version","slug":"update-the-domain-version"},{"level":2,"title":"Upload File API","slug":"upload-file-api"},{"level":3,"title":"Get files metadata","slug":"get-files-metadata"},{"level":3,"title":"Set domain version uploading status","slug":"set-domain-version-uploading-status"},{"level":3,"title":"Upload file","slug":"upload-file"}],"relativePath":"guide/spa-server-api.md"}',t={},o=e(`<h1 id="http-api" tabindex="-1">HTTP API <a class="header-anchor" href="#http-api" aria-hidden="true">#</a></h1><p>Admin server provide http api to control static web files version upgrade, so should take care for access, it&#39;s disabled by default.</p><p>The http api is described by <code>curl</code> command. You can run it in linux after variable changed.</p><h2 id="authorization" tabindex="-1">Authorization <a class="header-anchor" href="#authorization" aria-hidden="true">#</a></h2><p>It very simple, put <code>Token</code> to request http header: <code>Authorization: Bearer $TOKEN</code></p><h2 id="simple-api-without-spa-client" tabindex="-1">Simple API Without <code>spa-client</code> <a class="header-anchor" href="#simple-api-without-spa-client" aria-hidden="true">#</a></h2><p>These api give you simple info about serving domain, and you can change the version of SPA.</p><p>There are environment variables for shell:</p><div class="language-shell"><pre><code><span class="token assign-left variable">ADMIN_SERVER</span><span class="token operator">=</span><span class="token string">&#39;http://127.0.0.1:9000&#39;</span>
<span class="token comment"># admin_server.token</span>
<span class="token assign-left variable">TOKEN</span><span class="token operator">=</span><span class="token string">&#39;token&#39;</span>
</code></pre></div><h3 id="get-all-domains-status" tabindex="-1">Get all domains status <a class="header-anchor" href="#get-all-domains-status" aria-hidden="true">#</a></h3><div class="language-shell"><pre><code><span class="token function">curl</span> <span class="token string">&quot;<span class="token variable">$ADMIN_SERVER</span>/status&quot;</span> -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">$TOKEN</span>&quot;</span>
<span class="token comment"># return json: [{&quot;domain&quot;:&quot;www.example.com&quot;,&quot;current_version&quot;:2,&quot;versions&quot;:[1,2]}]</span>
</code></pre></div><h3 id="get-specific-domain-status" tabindex="-1">Get specific domain status <a class="header-anchor" href="#get-specific-domain-status" aria-hidden="true">#</a></h3><div class="language-shell"><pre><code><span class="token assign-left variable">DOMAIN</span><span class="token operator">=</span><span class="token string">&#39;www.example.com&#39;</span>
<span class="token function">curl</span> <span class="token string">&quot;<span class="token variable">$ADMIN_SERVER</span>/status?domain=<span class="token variable">$DOMAIN</span>&quot;</span> -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">$TOKEN</span>&quot;</span>
<span class="token comment"># return json: {&quot;domain&quot;:&quot;www.example.com&quot;,&quot;current_version&quot;:1,&quot;versions&quot;:[1]} </span>
<span class="token comment"># or status code:404</span>
</code></pre></div><h3 id="get-the-domain-upload-file-position-info" tabindex="-1">Get the domain upload file position info <a class="header-anchor" href="#get-the-domain-upload-file-position-info" aria-hidden="true">#</a></h3><p>it can be used with <code>rsync/scp</code> to upload web static files to the server.</p><div class="language-shell"><pre><code><span class="token assign-left variable">FORMAT</span><span class="token operator">=</span><span class="token string">&quot;Path&quot;</span># or <span class="token string">&quot;Json&quot;</span>, 
<span class="token comment"># &quot;Path&quot; will return the server location,you can use it with scp/rsync,</span>
<span class="token comment"># &quot;Json&quot; will return the version and path</span>
<span class="token comment"># format default value is &quot;Path&quot;</span>
<span class="token function">curl</span> <span class="token string">&quot;<span class="token variable">$ADMIN_SERVER</span>/upload/position?domain=<span class="token variable">$DOMAIN</span>&amp;format=<span class="token variable">$FORMAT</span>&quot;</span> <span class="token punctuation">\\</span>
-H <span class="token string">&quot;Authorization: Bearer <span class="token variable">$TOKEN</span>&quot;</span>
<span class="token comment"># return string if format is &quot;Path&quot;: /$FILE_PATH/$DOMAIN/$NEW_VERSION </span>
<span class="token comment"># like /data/www.example.com/2</span>
<span class="token comment"># return json if format is &quot;Json&quot;: </span>
<span class="token comment"># {&quot;path&quot;:&quot;/$FILE_PATH/$DOMAIN/$VERSION&quot;, version:$VERSION, &quot;status&quot;: $STATUS}</span>
<span class="token comment">#</span>
<span class="token comment"># $STATUS is a number,</span>
<span class="token comment"># 0: there no domain in server,</span>
<span class="token comment"># 1: the version directory is new,</span>
<span class="token comment"># 2: the version directory already has file </span>
</code></pre></div><h3 id="update-the-domain-version" tabindex="-1">Update the domain version <a class="header-anchor" href="#update-the-domain-version" aria-hidden="true">#</a></h3><p>Please be attention:</p><p><strong>it will use the newest or biggest version after server restart/reload</strong></p><p><code>OPT_VERSION</code> is optional, if not set, will try to use the max version of this domain to put it online.</p><div class="language-shell"><pre><code><span class="token assign-left variable">OPT_VERSION</span><span class="token operator">=</span><span class="token number">2</span>

<span class="token function">curl</span>  -X POST <span class="token string">&quot;<span class="token variable">$ADMIN_SERVER</span>/update_version&quot;</span><span class="token punctuation">\\</span>
 -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">$TOKEN</span>&quot;</span> <span class="token punctuation">\\</span>
--data-raw <span class="token variable"><span class="token variable">\`</span><span class="token punctuation">{</span>
    <span class="token string">&quot;domain&quot;</span>:$DOMAIN,
    <span class="token string">&quot;version&quot;</span><span class="token builtin class-name">:</span> OPT_VERSION,    
<span class="token punctuation">}</span><span class="token variable">\`</span></span>
<span class="token comment"># return status code: 200(update version success)</span>
<span class="token comment"># or 404 with string body: can not find files, please make sure you have upload files to correct place</span>

<span class="token comment"># reload static web server</span>
<span class="token function">curl</span> -X POST <span class="token string">&quot;<span class="token variable">$ADMIN_SERVER</span>/reload&quot;</span> -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">$TOKEN</span>&quot;</span>
</code></pre></div><h2 id="upload-file-api" tabindex="-1">Upload File API <a class="header-anchor" href="#upload-file-api" aria-hidden="true">#</a></h2><p>These api are used with <code>spa-client</code> to upload files to the server.</p><h3 id="get-files-metadata" tabindex="-1">Get files metadata <a class="header-anchor" href="#get-files-metadata" aria-hidden="true">#</a></h3><p>The result is used to prepare for uploading file. and it will calculate all files md5, so it&#39;s slow when there are large number of files.</p><div class="language-shell"><pre><code>
<span class="token function">curl</span> <span class="token string">&quot;http://<span class="token variable">$ADMIN_SERVER</span>/files/metadata?domain=<span class="token variable">$DOMAIN</span>&amp;version=<span class="token variable">$VERSION</span>&quot;</span> -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">$TOKEN</span>&quot;</span>
<span class="token comment"># return [{path:$path_string,md5:$md5_string, length: $file_length_integer}]</span>
</code></pre></div><h3 id="set-domain-version-uploading-status" tabindex="-1">Set domain version uploading status <a class="header-anchor" href="#set-domain-version-uploading-status" aria-hidden="true">#</a></h3><p><code>spa-client</code> use this api to tell admin server which domain version is to upload or upload finished.</p><div class="language-shell"><pre><code><span class="token assign-left variable">UPLOADING_STATUS</span><span class="token operator">=</span><span class="token number">0</span> <span class="token comment"># Uploading:0, Finish:1</span>

<span class="token function">curl</span> --location --request POST <span class="token string">&quot;http://<span class="token variable">$ADMIN_SERVER</span>/files/upload_status&quot;</span> <span class="token punctuation">\\</span>
--header <span class="token string">&quot;Authorization: Bearer <span class="token variable">$TOKEN</span>&quot;</span> <span class="token punctuation">\\</span>
--header <span class="token string">&#39;Content-Type: application/json&#39;</span> <span class="token punctuation">\\</span>
--data-raw <span class="token variable"><span class="token variable">\`</span><span class="token punctuation">{</span>
    <span class="token string">&quot;domain&quot;</span>:$DOMAIN,
    <span class="token string">&quot;version&quot;</span><span class="token builtin class-name">:</span> $VERSION,
    <span class="token string">&quot;status&quot;</span><span class="token builtin class-name">:</span> $UPLOADING_STATUS
<span class="token punctuation">}</span><span class="token variable">\`</span></span>
<span class="token comment"># return status code:200 if success </span>
</code></pre></div><h3 id="upload-file" tabindex="-1">Upload file <a class="header-anchor" href="#upload-file" aria-hidden="true">#</a></h3><p>The http body is <code>multipart/form-data</code> format.</p><div class="language-shell"><pre><code><span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token string">&quot;/upload/file/path&quot;</span>
<span class="token function">curl</span> -X POST <span class="token string">&quot;http://<span class="token variable">$ADMIN_SERVER</span>/file/upload&quot;</span> <span class="token punctuation">\\</span>
-F <span class="token string">&quot;file=@<span class="token environment constant">$PATH</span>&quot;</span> -F <span class="token string">&quot;domain=<span class="token variable">$DOMAIN</span>&quot;</span> -F <span class="token string">&quot;version=<span class="token variable">$VERSION</span>&quot;</span> -F <span class="token string">&quot;path=<span class="token environment constant">$PATH</span>&quot;</span>  -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">$TOKEN</span>&quot;</span>
<span class="token comment"># return status code:200 if success </span>
</code></pre></div>`,32),i=[o];function p(l,r,c,u,d,h){return n(),s("div",null,i)}var v=a(t,[["render",p]]);export{k as __pageData,v as default};
